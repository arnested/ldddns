name: Go version update
on:
  workflow_dispatch:
  schedule:
    - cron: '23 15 * * *'

permissions:
  contents: read
  pull-requests: write

jobs:
  stable:
    name: Stable
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: arnested/go-version-action@v1
        id: go-version
        with:
          patch-level: true
      - name: Setup Go ${{ steps.go-version.outputs.latest }}
        uses: WillAbides/setup-go-faster@v1.13.0
        with:
          go-version: ${{ steps.go-version.outputs.latest }}
      - run: go mod edit -go ${{ steps.go-version.outputs.latest }}
      - run: git diff
      - name: "Create pull request"
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: |
            Update Go version to ${{ steps.go-version.outputs.latest }}

            See [the release history](https://go.dev/doc/devel/release#go${{ steps.go-version.outputs.latest }}.
          branch: go-version-update
          delete-branch: true
          title: Update Go version to ${{ steps.go-version.outputs.latest }}
          token: ${{ secrets.PAT_TOKEN }}
  unstable:
    name: Unstable
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: arnested/go-version-action@v1
        id: go-version
        with:
          patch-level: true
          unstable: true
      - uses: arnested/go-version-action@v1
        id: go-minor-version
        with:
          unstable: true
      - name: Setup Go ${{ steps.go-version.outputs.latest }}
        uses: WillAbides/setup-go-faster@v1.13.0
        with:
          go-version: ${{ steps.go-version.outputs.latest }}
      - run: go mod edit -go ${{ steps.go-version.outputs.latest }}
      - run: git diff
      - name: "Create pull request"
        uses: peter-evans/create-pull-request@v5
        with:
          draft: true
          commit-message: |
            Test Go unstable version ${{ steps.go-version.outputs.latest }}

            See [the draft release notes](https://tip.golang.org/doc/go${{ steps.go-minor-version.outputs.latest }}.

            This pull request is only intented for getting feedback on compatibility with future Go versions. Don't merge it!
          branch: go-version-unstable-test
          delete-branch: true
          title: Test Go unstable version ${{ steps.go-version.outputs.latest }}
          token: ${{ secrets.PAT_TOKEN }}
